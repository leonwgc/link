!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.link=t()}(this,function(){"use strict";function e(e){return!!e&&"object"==typeof e}function t(e){return"function"==typeof e}function n(e){return"string"==typeof e}function r(e){return"boolean"==typeof e}function i(e){return n(e)&&"{"===e[0]&&"}"===e[e.length-1]}function o(e,t){e.className.indexOf(t)===-1&&(e.className=u(e.className)+" "+t)}function l(e,t){e.className.indexOf(t)>-1&&(e.className=e.className.replace(new RegExp(t,"g"),""))}function u(e){return"string"==typeof e?e.trim():e}function s(e,t){for(var n=e.length,r=-1;++r<n;)t(e[r],r,e)}function a(e,t,n){return s(Object.keys(t),function(r){e[r]&&n||(e[r]=t[r])}),e}function c(e,t,n,r){e.addEventListener&&(e.addEventListener(t,n,!1),r.push({el:e,event:t,handler:n}))}function h(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)}function f(e,t,n){var r=e[t];if(r)n(r);else{var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&200===i.status&&(e[t]=u(i.responseText),n(i.responseText))},i.open("GET",t,!0),i.setRequestHeader("Accept","text/html"),i.send(null)}}function d(e){var t=e.split("."),n=t.length,r=t[n-1];return function(e,i){for(var o=e,l=0;l<n-1;l++)o=o[t[l]];return 1===arguments.length?o[r]:void(o[r]=i)}}function p(e,t){return se[t]||(se[t]=m(t))}function m(e){return new Function("t","with(t){ return "+e+";}")}function v(e){if("undefined"==typeof e){var t=location.href,n=t.indexOf("#");return n===-1?"":t.slice(n+1)}location.hash=e}function g(e){var t=location.href,n=t.indexOf("#");n>-1?location.replace(t.slice(0,n)+"#"+e):location.replace(t+"#"+e)}function y(t){function n(){var n=r[v()];if(!n)return void g(i);n.model&&e(n.model)||(n.model={});var o=u(n.template);o?b(t,n,o):n.templateUrl?f(t._routeTplStore,n.templateUrl,function(e){b(t,n,e)}):b(t,n,"")}var r=t._routes.routes,i=t._routes.defaultPath;c(window,"hashchange",n,t._eventStore),n()}function b(e,n,r){function i(){e._routeEl&&(n.lastLinker=new Se({el:e._routeEl,model:n.model,methods:n.methods}),t(n.postLink)&&n.postLink.call(n,n.lastLinker))}var o;if(e._routeEl&&(e._routeEl.innerHTML=r),n.lastLinker&&n.lastLinker.unlink(),t(n.preLink)&&(o=n.preLink.call(n,e)),o&&t(o.then))o.then(i);else{if(o===!1)return;i()}}function _(e,t){function n(){e.setPath(e.el.value)}c(e.el,t,n,e.linker._eventStore)}function k(e){function t(){var t,i=n.value,o=n.checked,l=e.value;if(r(l))e.setPath(o);else{if(!Array.isArray(l))throw new Error("checkbox should bind with array or boolean value");t=l.indexOf(i),!o&&t>-1?l.splice(t,1):l.push(i)}}var n=e.el;c(n,"click",t,e.linker._eventStore)}function w(e){var t=e.el,n=t.nodeName,r=t.type;if("INPUT"===n)switch(r){case"text":case"password":_(e,"keyup");break;case"radio":_(e,"click");break;case"checkbox":k(e);break;default:_(e,"keyup")}else"SELECT"===n?_(e,"change"):_(e,"keyup")}function x(e){e.el.textContent=e.value}function E(e){var t=e.value;e.className?t?o(e.el,e.className):l(e.el,e.className):t&&o(e.el,t)}function A(e){e.value?e.el.setAttribute("disabled","disabled"):e.el.removeAttribute("disabled")}function C(e){var t=e.el,n=e.value;if("radio"===t.type){var i=t.value===n;t.checked!=i&&(t.checked=i)}else if("checkbox"===t.type)if(Array.isArray(n))t.checked=n.indexOf(t.value)>-1;else{if(!r(n))throw Error("checkbox should bind with array or a boolean value");t.checked!==n&&(t.checked=n)}else t.value!=n&&(t.value=n)}function O(e){e.value?e.el.setAttribute("readonly","readonly"):e.el.removeAttribute("readonly")}function S(e){return ae.indexOf(typeof e)>-1}function L(e,t,n,r,i){var o,l=e.linker.model,u=Object.create(null),s=e.dirs;return s||(e.dirs=s=[],X(e.linker,r,s)),u.$index={value:n,enumerable:!0,configurable:!0,writable:!0},u[e["var"]]={value:t,enumerable:!0,configurable:!0,writable:!0},o=new Se({el:r,model:Object.create(l,u),dirs:s.slice()}),e.linker._children.push(o),o}function T(e,t,n,r){function i(){for(var e=d.length;e--;)if(f.indexOf(d[e])===-1)return d[e]}function o(){var e,t,n=u.length,r=f.length,o=d.length;if(!n)return void(r&&(s(f,function(e){p.removeChild(e.el),m||e.unlink()}),f.length=0));if(m)if(r>=n){s(u,function(e,t){f[t].model[a]=e});for(var c=n;c<r;c++)p.removeChild(f[c].el);f.length=n}else{t=document.createDocumentFragment(),s(f,function(e,t){e.model[a]=u[t]});var v=r;if(o>r)do e=i(),e.model[a]=u[v++],f.push(e),t.appendChild(e.el);while(o>f.length&&v<n);for(;v<n;)l(u[v],v++,m,t)}else t=document.createDocumentFragment(),s(f,function(e){p.removeChild(e.el),e.unlink()}),f.length=0,s(u,function(e,n){l(e,n,m,t)});t&&p.insertBefore(t,h)}function l(t,n,r,i,o){var l=L(e,t,n,c.cloneNode(!0),r);return o||f.push(l),r&&d.push(l),i&&i.appendChild(l.el),l}if(!r||"mutate"!==r.op){var u=t,a=e["var"],c=e.el,h=e.comment,f=e.lastLinkers,d=e.allLinkers,p=c.parentNode||h.parentNode,m=e.valIsPrimitive;if("undefined"==typeof m&&u.length&&(m=e.valIsPrimitive=S(u[0])),f||(f=e.lastLinkers=[],d=e.allLinkers=[],h=e.comment=document.createComment(""+a),p.insertBefore(h,c),p.removeChild(c)),r){var v,g,y=r.op,b=r.args;r.hasNew;switch(y){case"push":(n===t||t.length>n.length)&&(v=u.length-1,g=l(u[v],v,m),p.insertBefore(g.el,h));break;case"pop":(n===t||t.length<n.length)&&(g=f.pop(),p.removeChild(g.el),m||g.unlink());break;case"splice":g=Array.prototype.splice.apply(f,b),s(g,function(e){p.removeChild(e.el),m||e.unlink()}),s(f,function(e,t){e.model.$index=t});break;case"unshift":(n===t||t.length>n.length)&&(g=l(u[0],0,m,null,!0),p.insertBefore(g.el,f[0].el),f.unshift(g));break;case"shift":(n===t||t.length<n.length)&&(g=f.shift(),p.removeChild(g.el),m||g.unlink());break;default:o()}}else o()}}function j(e){return function(t){var n=t.value,r=t.el;e&&n||!e&&!n?(l(r,"x-hide"),r.style.display=""):(o(r,"x-hide"),r.style.display="none")}}function N(e){e&&"object"==typeof e&&(Array.isArray(e)?e.forEach(function(e){return N(e)}):Object.keys(e).forEach(function(t){return N(e[t])}))}function P(e,t){return e.replace(re,function(e,n){return U(n,t)})}function D(e,t){return U(e,t)}function U(e,t){var n,r,i=e.split("|");return 1===i.length?p(t,e)(t):(r=i[0].trim(),n=i[1].trim(),ue[n](p(t,r)(t)))}function M(e,t){return t?be.test(e):$(e)}function $(e){if(e.indexOf("|")===-1)return!1;for(var t,n,r=e.length,i=0;i<r;)if(t=e[i],'"'===t||"'"===t){for(n=i+1;n<r&&e[n]!==t;)++i;if(!(i<r))throw new Error("bad text");i+=2}else if("|"===t){if(n=i+1,n<r&&e[n]!==t)return!0;i+=2}else++i;return!1}function q(e,t){return function(n){return t?P(e,n):D(e,n)}}function B(e){var t=fe[e.directive];return function(n,r,i){return e.value=n,t(e,n,r,i)}}function H(e){var t=d(e);return function(e){return t(this.linker.model,e)}}function F(e){return xe[e]||(xe[e]=new Function("m","$event","with(m){"+e+"}"))}function G(e,t){var n=F(e);return function(e){n(t,e)}}function R(e,t,n,r){return we.create(t,"x-bind",null,n,e,r)}function I(e,t,n,r,i){var o,l=r.slice(1,-1).split(","),u=[];return s(l,function(r){o=r.split(":");var l=we.create(t,n,o[1].trim(),null,e,i);l.className=o[0].trim(),u.push(l)}),u}function z(e,t,n,r,o){var l,u=[];return i(r)?(l=I(e,t,n,r,o),u=u.concat(l)):(l=we.create(t,n,r,null,e,o),u.push(l)),u}function V(e,t){if(t._dirs.length){var n=t._dirs.shift();n&&s(n,function(n){n instanceof we?n.clone(e,t):c(e,n.name,G(n.expr,t.model),t._eventStore)}),1===e.nodeType&&s(e.childNodes,function(e){V(e,t)})}}function X(e,t,n){var r,i,o,l,a,h,f,d,p=t.nodeType,m=[];if(1===p){if(a=t.hasAttributes()){if(t.hasAttribute("x-for")){if(i=u(t.getAttribute("x-for")),o=i.split(ie),d=o.length,3!==d&&6!==d)throw new Error("repeat only support expr like: var in array [track by expr].");return t.removeAttribute("x-for"),l=we.create(t,"x-for",o[2],null,e,n),l["var"]=o[0],6===d&&(l.trackBy=o[5].slice(o[5].indexOf(".")+1)),void(n&&(m.push(l),n.push(m)))}if(t.hasAttribute("x-view")){if(e._routeEl)throw new Error("a link context can only have on more than one x-view");return t.removeAttribute("x-view"),void(e._routeEl=t)}s(t.attributes,function(r){if(h=r.name,f=r.value.trim(),fe[h]){var i=z(e,t,h,f,n);n&&(m=m.concat(i))}else h[0]===oe&&(n?m.push(Ee.get(h.slice(1),f)):c(t,h.slice(1),G(f,e.model),e._eventStore))})}if(te.registeredTagsCount>0&&(r=t.tagName.toUpperCase(),te.registeredTags[r]))return void e._comCollection.push({el:t,config:te.registeredTags[r]});n&&n.push(m.length?m:null),s(t.childNodes,function(t){X(e,t,n)})}else 3===p?(i=t.textContent.trim(),i.length&&ne.test(i)&&m.push(R(e,t,i,n)),n&&n.push(m.length?m:null)):9===p&&s(t.childNodes,function(t){X(e,t)})}function J(e,t,n){var r=Q(n)||new Ce;Object.defineProperty(e,t,{get:function(){var e=ve.target;return e&&r.addSub(e),n},set:function(e){if(e!==n){if(e!==e&&n!==n)return;if(n=e,"object"==typeof e&&e){var t=r;r=Q(e),t.notify(Array.isArray(e))}else r.notify()}}})}function K(e){s(le,function(t){e[t]=function(n){var r,i=Oe.call(arguments),o=1===i.length?Array.prototype[t].call(e,n):Array.prototype[t].apply(e,i);switch(t){case"push":r=i;break;case"unshift":r=i;break;case"splice":r=i.slice(2)}return r&&r.forEach(function(e){return Q(e)}),e.__dep__.notify({op:t,args:i}),o}})}function Q(e){if(e&&"object"==typeof e){if(e.hasOwnProperty("__dep__")&&e.__dep__ instanceof Ce)return e.__dep__;var t=new Ce;return Object.defineProperty(e,"__dep__",{value:t}),Array.isArray(e)?(K(e),e.forEach(function(e){return Q(e)})):Object.keys(e).forEach(function(t){return J(e,t,e[t])}),t}}function W(e){var t=e.tag;if(!t)throw new Error("tag is required for a component!");t=t.toUpperCase(),te.registeredTags[t]||(te.registeredTags[t]=e,++te.registeredTagsCount)}function Y(e,t){var n=t.config,r=u(n.template),i=t.el;r?Z(e,i,n,r):n.templateUrl&&f(e._comTplStore,n.templateUrl,function(t){Z(e,i,n,t)})}function Z(e,n,r,i){if(!t(r.model))throw new Error("component model must be a function to return a model data");var o=r.model(),l=r.methods||{};if(n.innerHTML=i,n.children.length>1)throw new Error("component can only have one root element");if(Array.isArray(r.props)){var u,a;s(r.props,function(r){u=n.getAttribute(r).trim(),t(e.model[u])?l[r]=e.model[u]:(a=d(u)(e.model),a!==o[r]&&(o[r]=a),e.watch(u,function(e){o[r]=e}))})}var c=new Se({el:n.children[0],model:o,methods:l});t(r.postLink)&&r.postLink.call(o,c,r)}function ee(t){if(!e(t))throw new Error("config must be an object.");return t.el||(t.el=window.document),new Se(t)}var te={registeredTagsCount:0,registeredTags:Object.create(null)},ne=/\{\{[^\}]+\}\}/,re=/\{\{([^\}]+)\}\}/g,ie=/\s+/,oe="@",le=["push","pop","unshift","shift","reverse","sort","splice"],ue=Object.create(null),se=Object.create(null),ae=["string","number","boolean"],ce=j(!0),he=j(!1),fe={"x-show":ce,"x-hide":he,"x-bind":x,"x-disabled":A,"x-for":T,"x-class":E,"x-model":C,"x-readonly":O},de=/^[\w$]+(\.[\w$]+)*$/,pe=0,me={op:"mutate"},ve=function(e,t,n,r){this.id=++pe,this.getter="function"==typeof e?e:de.test(e)?d(e):p(t.model,e),this.linker=t,this.model=t.model,this.deep=r,this.lazy=!n,this.cb=n};ve.prototype.getDeps=function(){return ve.target=this,this.value=this.getter.call(this.model,this.model),this.deep&&N(this.value),ve.target=null,this},ve.prototype.getValue=function(){this.value=this.getter.call(this.model,this.model)},ve.prototype.update=function(e){if(this.lazy)return void(this.dirty=!0);var t=this.value;this.getDeps(),t!==this.value||e?this.cb.call(this.model,this.value,t,e):Array.isArray(this.value)&&this.cb.call(this.model,this.value,t,me)},ve.prototype.updateAsync=function(){ve.run(this)},ve.get=function(e,t,n,r){return new ve(e,t,n,r)},ve.target=null;var ge=[],ye=!1;ve.run=function(e){return link.sync?void e.update():void(e.waiting||(e.waiting=!0,ge.push(e),ye||(ye=!0,setTimeout(function(){for(var e,t=0;t<ge.length;t++)e=ge[t],e.waiting=!1,e.update();ge.length=0,ye=!1},0))))};var be=/\{\{[^\}\|]+\|[^\}\|]+\}\}/,_e=/(\{\{)/g,ke=/(\}\})/g,we=function(e,t,n){this.el=e,this.directive=t,this.linker=n};we.prototype.clone=function(e,t){var n=new we(e,this.directive,t);return a(n,this,!0),n.watcher=ve.get(this.watcher.getter,t,B(n)),t._watchers.push(n.watcher),"x-model"===this.directive&&w(n),n},we.create=function(e,t,n,r,i,o){var l="x-model"===t,u=new we(e,t,i);return r?u.watcher=ve.get(M(r,!0)?q(r,!0):('"'+r+'"').replace(_e,'"+(').replace(ke,')+"'),i,B(u)):u.watcher=ve.get("x-bind"!==t?n:q(n,!1),i,B(u)),l&&(u.setPath=H(n)),o||(l&&w(u),i._watchers.push(u.watcher)),u};var xe=Object.create(null),Ee=function(e,t){this.name=e,this.expr=t};Ee.get=function(e,t){return new Ee(e,t)};var Ae=0,Ce=function(){this.id=++Ae,this.has=Object.create(null),this.subs=[],this.deadSubs=[]};Ce.prototype.addSub=function(e){this.has[e.id]||(this.has[e.id]=!0,this.subs.push(e))},Ce.prototype.removeSub=function(e){this.has[e.id]&&delete this.has[e.id];var t=this.subs.indexOf(e);t>-1&&this.subs.splice(t,1)},Ce.prototype.notify=function(e){var t=this;this.subs.forEach(function(n){n.dead?t.deadSubs.push(n):e?n.update(e):n.updateAsync()}),this.deadSubs.length&&(this.deadSubs.forEach(function(e){return t.removeSub(e)}),this.deadSubs.length=0)};var Oe=Array.prototype.slice,Se=function(e){this.el=n(e.el)?document.querySelector(e.el):e.el,this.model=e.model||{},this._methods=e.methods,this._routes=e.routes,this._dirs=e.dirs,this._computed=e.computed,this._eventStore=[],this._watchers=[],this._children=[],this._routeEl=null,this._comCollection=[],this._unlinked=!1,this._bootstrap(),this._routes&&(this._routeTplStore=Object.create(null),y(this)),te.registeredTagsCount>0&&this._comCollection.length>0&&(this._comTplStore=Object.create(null),this._renderComponent())};return Se.prototype._bootstrap=function(){Q(this.model),this._addComputed(),this._compileDOM(),this._watchers.forEach(function(e){return e.update()}),this._methods&&a(this.model,this._methods,!0)},Se.prototype._addComputed=function(){var e,t=this;for(var n in this._computed)if(e=t._computed[n],"function"==typeof e)Object.defineProperty(t.model,n,{enumerable:!0,get:t._makeComputedGetter(e)});else{var r={enumerable:!0};"function"==typeof e.get&&(r.get=t._makeComputedGetter(e.get)),"function"==typeof e.set&&(r.set=e.set),Object.defineProperty(t.model,n,r)}},Se.prototype._makeComputedGetter=function(e){var t=ve.get(e,this,null).getDeps();return function(){return(t.dirty||ve.target)&&(t.getValue(),t.dirty=!1),t.value}},Se.prototype._renderComponent=function(){var e=this;s(this._comCollection,function(t){Y(e,t)})},Se.prototype.watch=function Le(Le,e,t){ve.get(Le,this,e,t).getDeps()},Se.prototype._compileDOM=function(){this._dirs?V(this.el,this):X(this,this.el)},Se.prototype.unlink=function(){this._unlinked||(this._unlinked=!0,this._comCollection.length=0,this._children.forEach(function(e){return e.unlink()}),this._watchers.forEach(function(e){return e.dead=!0}),s(this._eventStore,function(e){h(e.el,e.event,e.handler)}),this._eventStore.length=0,this.model=null)},ee.filter=function(e,t){ue[e]||"function"!=typeof t||(ue[e]=t)},ee.com=W,ee});