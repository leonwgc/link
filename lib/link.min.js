!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.link=t()}(this,function(){"use strict";function e(e){return!!e&&"object"==typeof e}function t(e){return"function"==typeof e}function n(e){return"string"==typeof e}function r(e){return"boolean"==typeof e}function i(e){return n(e)&&"{"===e[0]&&"}"===e[e.length-1]}function o(e,t){e.className.indexOf(t)===-1&&(e.className=l(e.className)+" "+t)}function s(e,t){e.className.indexOf(t)>-1&&(e.className=e.className.replace(new RegExp(t,"g"),""))}function l(e){return"string"==typeof e?e.trim():e}function u(e,t){for(var n=e.length,r=-1;++r<n;)t(e[r],r,e)}function a(e,t,n){return u(Object.keys(t),function(r){e[r]&&n||(e[r]=t[r])}),e}function c(e,t,n){var r=e[t];if(r)n(r);else{var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&200===i.status&&(e[t]=l(i.responseText),n(i.responseText))},i.open("GET",t,!0),i.setRequestHeader("Accept","text/html"),i.send(null)}}function h(e){var t=e.split("."),n=t.length,r=t[n-1];return function(e,i){for(var o=e,s=0;s<n-1;s++)o=o[t[s]];return 1===arguments.length?o[r]:void(o[r]=i)}}function f(e,t){return se[t]||(se[t]=d(t))}function d(e){return new Function("t","with(t){ return "+e+";}")}function p(e){if("undefined"==typeof e){var t=location.href,n=t.indexOf("#");return n===-1?"":t.slice(n+1)}location.hash=e}function m(e){var t=location.href,n=t.indexOf("#");n>-1?location.replace(t.slice(0,n)+"#"+e):location.replace(t+"#"+e)}function v(t){function n(){var n=r[p()];if(!n)return void m(i);n.model&&e(n.model)||(n.model={});var o=l(n.template);o?y(t,n,o):n.templateUrl?c(t._routeTplStore,n.templateUrl,function(e){y(t,n,e)}):y(t,n,"")}var r=t._routes.routes,i=t._routes.defaultPath;t._eventInfos.unshift({el:window,name:"hashchange",handler:n}),n()}function y(e,n,r){function i(){e._routeEl&&(n.lastLinker=new Oe({el:e._routeEl,model:n.model,methods:n.methods}),t(n.postLink)&&n.postLink.call(n,n.lastLinker))}var o;if(e._routeEl&&(e._routeEl.innerHTML=r),n.lastLinker&&n.lastLinker.unlink(),t(n.preLink)&&(o=n.preLink.call(n,e)),o&&t(o.then))o.then(i);else{if(o===!1)return;i()}}function g(e,t){function n(){e.setPath(e.el.value)}e.linker._eventInfos.unshift({el:e.el,name:t,handler:n})}function b(e){function t(){var t,i=n.value,o=n.checked,s=e.watcher.value;if(r(s))e.setPath(o);else{if(!Array.isArray(s))throw new Error("checkbox should bind with array or boolean value");t=s.indexOf(i),!o&&t>-1?s.splice(t,1):s.push(i)}}var n=e.el;e.linker._eventInfos.unshift({el:n,name:"click",handler:t})}function _(e){var t=e.el,n=t.nodeName,r=t.type;if("INPUT"===n)switch(r){case"text":case"password":g(e,"keyup");break;case"radio":g(e,"click");break;case"checkbox":b(e);break;default:g(e,"keyup")}else"SELECT"===n?g(e,"change"):g(e,"keyup")}function k(e){this.el.textContent=e}function w(e){this.className?e?o(this.el,this.className):s(this.el,this.className):e&&o(this.el,e)}function x(e){e?this.el.setAttribute("disabled","disabled"):this.el.removeAttribute("disabled")}function E(e){var t=this.el;if("radio"===t.type){var n=t.value===e;t.checked!=n&&(t.checked=n)}else if("checkbox"===t.type)if(Array.isArray(e))t.checked=e.indexOf(t.value)>-1;else{if(!r(e))throw Error("checkbox should bind with array or a boolean value");t.checked!==e&&(t.checked=e)}else t.value!=e&&(t.value=e)}function C(e){e?this.el.setAttribute("readonly","readonly"):this.el.removeAttribute("readonly")}function O(e){return le.indexOf(typeof e)>-1}function A(e,t,n,r,i){var o,s=e.linker.model,l=Object.create(null),u=e.dirs;return u||(e.dirs=u=[],z(e.linker,r,u)),l.$index={value:n,enumerable:!0,configurable:!0,writable:!0},l[e["var"]]={value:t,enumerable:!0,configurable:!0,writable:!0},o=new Oe({el:r,model:Object.create(s,l),dirs:u.slice()}),e.linker._children.push(o),o}function j(e,t,n){function r(){for(var e=d.length;e--;)if(f.indexOf(d[e])===-1)return d[e]}function i(){var e,t,n,i=l.length,s=f.length;if(!i)return void(s&&(u(f,function(e){p.removeChild(e.el),m||e.unlink()}),f.length=0));if(m)if(s>=i){u(l,function(e,t){f[t].model[a]=e});for(var c=i;c<s;c++)p.removeChild(f[c].el);f.length=i}else{t=document.createDocumentFragment(),n=d.length,u(f,function(e,t){e.model[a]=l[t]});var v=s;if(n>s)do e=r(),e.model[a]=l[v++],f.push(e),t.appendChild(e.el);while(n>f.length&&v<i);for(;v<i;)o(l[v],v++,m,t)}else t=document.createDocumentFragment(),u(f,function(e){p.removeChild(e.el),e.unlink()}),f.length=0,u(l,function(e,n){o(e,n,m,t)});t&&p.insertBefore(t,h)}function o(e,t,n,r,i){var o=A(s,e,t,c.cloneNode(!0),n);return i||f.push(o),n&&d.push(o),r&&r.appendChild(o.el),o}if(!n||"mutate"!==n.op){var s=this,l=e,a=this["var"],c=this.el,h=this.comment,f=this.lastLinkers,d=this.allLinkers,p=c.parentNode||h.parentNode,m=this.valIsPrimitive;if("undefined"==typeof m&&l.length&&(m=this.valIsPrimitive=O(l[0])),f||(f=this.lastLinkers=[],d=this.allLinkers=[],h=this.comment=document.createComment(""+a),p.insertBefore(h,c),p.removeChild(c)),n){var v,y,g=n.op,b=n.args,_=t===e;switch(g){case"push":(_||e.length>t.length)&&(v=l.length-1,y=o(l[v],v,m),p.insertBefore(y.el,h));break;case"pop":(_||e.length<t.length)&&(y=f.pop(),p.removeChild(y.el),m||y.unlink());break;case"splice":y=Array.prototype.splice.apply(f,b),u(y,function(e){p.removeChild(e.el),m||e.unlink()}),u(f,function(e,t){e.model.$index=t});break;case"unshift":(_||e.length>t.length)&&(y=o(l[0],0,m,null,!0),p.insertBefore(y.el,f[0].el),f.unshift(y));break;case"shift":(_||e.length<t.length)&&(y=f.shift(),p.removeChild(y.el),m||y.unlink());break;default:i()}}else i()}}function T(e){return function(t){var n=this.el;e&&t||!e&&!t?(s(n,"x-hide"),n.style.display=""):(o(n,"x-hide"),n.style.display="none")}}function L(e){e&&"object"==typeof e&&(Array.isArray(e)?e.forEach(function(e){return L(e)}):Object.keys(e).forEach(function(t){return L(e[t])}))}function N(e,t){return e.replace(te,function(e,n){return I(n,t)})}function S(e,t){return I(e,t)}function I(e,t){var n,r,i=e.split("|");return 1===i.length?f(t,e)(t):(r=i[0].trim(),n=i[1].trim(),oe[n](f(t,r)(t)))}function P(e,t){return t?ye.test(e):D(e)}function D(e){if(e.indexOf("|")===-1)return!1;for(var t,n,r=e.length,i=0;i<r;)if(t=e[i],'"'===t||"'"===t){for(n=i+1;n<r&&e[n]!==t;)++i;if(!(i<r))throw new Error("bad text");i+=2}else if("|"===t){if(n=i+1,n<r&&e[n]!==t)return!0;i+=2}else++i;return!1}function H(e,t){return function(n){return t?N(e,n):S(e,n)}}function U(e){var t=ce[e.directive];return function(n,r,i){return t.call(e,n,r,i)}}function M(e){var t=h(e);return function(e){return t(this.linker.model,e)}}function $(e){return ke[e]||(ke[e]=new Function("m","$event","with(m){"+e+"}"))}function q(e,t){var n=$(e);return function(e){n(t,e)}}function B(e,t,n,r){return _e.create(t,"x-bind",null,n,e,r)}function F(e,t,n,r,i){var o,s=r.slice(1,-1).split(","),l=[];return u(s,function(r){o=r.split(":");var s=_e.create(t,n,o[1].trim(),null,e,i);s.className=o[0].trim(),l.push(s)}),l}function G(e,t,n,r,o){var s,l=[];return i(r)?(s=F(e,t,n,r,o),l=l.concat(s)):(s=_e.create(t,n,r,null,e,o),l.push(s)),l}function R(e,t){if(t._dirs.length){var n=t._dirs.shift();n&&u(n,function(n){n instanceof _e?n.clone(e,t):t._eventInfos.push({el:e,name:n.name,handler:q(n.expr,t.model)})}),1===e.nodeType&&u(e.childNodes,function(e){R(e,t)})}}function z(e,t,n){var r,i,o,s,a,c,h,f,d=t.nodeType,p=[];if(1===d){if(a=t.hasAttributes()){if(t.hasAttribute("x-for")){if(i=l(t.getAttribute("x-for")),o=i.split(ne),f=o.length,3!==f&&6!==f)throw new Error("repeat only support expr like: var in array [track by expr].");return t.removeAttribute("x-for"),s=_e.create(t,"x-for",o[2],null,e,n),s["var"]=o[0],6===f&&(s.trackBy=o[5].slice(o[5].indexOf(".")+1)),void(n&&(p.push(s),n.push(p)))}if(t.hasAttribute("x-view")){if(e._routeEl)throw new Error("a link context can only have on more than one x-view");return t.removeAttribute("x-view"),void(e._routeEl=t)}u(t.attributes,function(r){if(c=r.name,h=r.value.trim(),ce[c]){var i=G(e,t,c,h,n);n&&(p=p.concat(i))}else c[0]===re&&(n?p.push({name:c.slice(1),expr:h}):e._eventInfos.push({el:t,name:c.slice(1),handler:q(h,e.model)}))})}if(Z.registeredTagsCount>0&&(r=t.tagName.toUpperCase(),Z.registeredTags[r]))return void e._comCollection.push({el:t,config:Z.registeredTags[r]});n&&n.push(p.length?p:null),u(t.childNodes,function(t){z(e,t,n)})}else 3===d?(i=t.textContent.trim(),i.length&&ee.test(i)&&p.push(B(e,t,i,n)),n&&n.push(p.length?p:null)):9===d&&u(t.childNodes,function(t){z(e,t)})}function V(e,t,n){var r=J(n)||new xe;Object.defineProperty(e,t,{get:function(){var e=pe.target;return e&&r.addSub(e),n},set:function(e){if(e!==n){if(e!==e&&n!==n)return;if(n=e,"object"==typeof e&&e){var t=r;r=J(e),t.notify(Array.isArray(e))}else r.notify()}}})}function X(e){u(ie,function(t){e[t]=function(n){var r,i=Ee.call(arguments),o=1===i.length?Array.prototype[t].call(e,n):Array.prototype[t].apply(e,i);switch(t){case"push":r=i;break;case"unshift":r=i;break;case"splice":r=i.slice(2)}return r&&r.forEach(function(e){return J(e)}),e.__dep__.notify({op:t,args:i}),o}})}function J(e){if(e&&"object"==typeof e){if(e.hasOwnProperty("__dep__")&&e.__dep__ instanceof xe)return e.__dep__;var t=new xe;return Object.defineProperty(e,"__dep__",{value:t}),Array.isArray(e)?(X(e),e.forEach(function(e){return J(e)})):Object.keys(e).forEach(function(t){return V(e,t,e[t])}),t}}function K(e){var t=e.tag;if(!t)throw new Error("tag is required for a component!");t=t.toUpperCase(),Z.registeredTags[t]||(Z.registeredTags[t]=e,++Z.registeredTagsCount)}function Q(e,t){var n=t.config,r=l(n.template),i=t.el;r?W(e,i,n,r):n.templateUrl&&c(e._comTplStore,n.templateUrl,function(t){W(e,i,n,t)})}function W(e,n,r,i){if(n.innerHTML=i,n.children.length>1)throw new Error("component can only have one root element");var o=a({},r);if(o.model&&"function"!=typeof o.model)throw new Error("component model must be a function to return a model data");var s=o.model=o.model(),l=o.methods||{};if(o.el=n.children[0],Array.isArray(o.props)){var u,c;o.props.forEach(function(r){u=n.getAttribute(r).trim(),t(e.model[u])?l[r]=e.model[u]:(c=h(u)(e.model),c!==s[r]&&(s[r]=c),e.watch(u,function(e){s[r]=e}))})}e._children.push(new Oe(o))}function Y(t){if(!e(t))throw new Error("config must be an object.");return t.el||(t.el=window.document),new Oe(t)}var Z={registeredTagsCount:0,registeredTags:Object.create(null)},ee=/\{\{[^\}]+\}\}/,te=/\{\{([^\}]+)\}\}/g,ne=/\s+/,re="@",ie=["push","pop","unshift","shift","reverse","sort","splice"],oe=Object.create(null),se=Object.create(null),le=["string","number","boolean"],ue=T(!0),ae=T(!1),ce={"x-show":ue,"x-hide":ae,"x-bind":k,"x-disabled":x,"x-for":j,"x-class":w,"x-model":E,"x-readonly":C},he=/^[\w$]+(\.[\w$]+)*$/,fe=0,de={op:"mutate"},pe=function(e,t,n,r){this.id=++fe,this.getter="function"==typeof e?e:he.test(e)?h(e):f(t.model,e),this.linker=t,this.model=t.model,this.deep=r,this.lazy=!n,this.cb=n};pe.prototype.getDeps=function(){return pe.target=this,this.value=this.getter.call(this.model,this.model),this.deep&&L(this.value),pe.target=null,this},pe.prototype.getValue=function(){this.value=this.getter.call(this.model,this.model)},pe.prototype.update=function(e){if(this.lazy)return void(this.dirty=!0);var t=this.value;this.getDeps(),t!==this.value||e?this.cb.call(this.model,this.value,t,e):Array.isArray(this.value)&&this.cb.call(this.model,this.value,t,de)},pe.prototype.updateAsync=function(){pe.run(this)},pe.get=function(e,t,n,r){return new pe(e,t,n,r)},pe.target=null;var me=[],ve=!1;pe.run=function(e){return link.sync?void e.update():void(e.waiting||(e.waiting=!0,me.push(e),ve||(ve=!0,setTimeout(function(){for(var e,t=0;t<me.length;t++)e=me[t],e.waiting=!1,e.update();me.length=0,ve=!1},0))))};var ye=/\{\{[^\}\|]+\|[^\}\|]+\}\}/,ge=/(\{\{)/g,be=/(\}\})/g,_e=function(e,t,n){this.el=e,this.directive=t,this.linker=n};_e.prototype.clone=function(e,t){var n=new _e(e,this.directive,t);return a(n,this,!0),n.watcher=pe.get(this.watcher.getter,t,U(n)),t._watchers.push(n.watcher),"x-model"===this.directive&&_(n),n},_e.create=function(e,t,n,r,i,o){var s="x-model"===t,l=new _e(e,t,i);return r?l.watcher=pe.get(P(r,!0)?H(r,!0):('"'+r+'"').replace(ge,'"+(').replace(be,')+"'),i,U(l)):l.watcher=pe.get("x-bind"!==t?n:H(n,!1),i,U(l)),s&&(l.setPath=M(n)),o||(s&&_(l),i._watchers.push(l.watcher)),l};var ke=Object.create(null),we=0,xe=function(){this.id=++we,this.has=Object.create(null),this.subs=[],this.deadSubs=[]};xe.prototype.addSub=function(e){this.has[e.id]||(this.has[e.id]=!0,this.subs.push(e))},xe.prototype.removeSub=function(e){this.has[e.id]&&delete this.has[e.id];var t=this.subs.indexOf(e);t>-1&&this.subs.splice(t,1)},xe.prototype.notify=function(e){var t=this;this.subs.forEach(function(n){n.dead?t.deadSubs.push(n):e?n.update(e):n.updateAsync()}),this.deadSubs.length&&(this.deadSubs.forEach(function(e){return t.removeSub(e)}),this.deadSubs.length=0)};var Ee=Array.prototype.slice,Ce=["created"],Oe=function(e){this.el=n(e.el)?document.querySelector(e.el):e.el,this.model=e.model||{},this._methods=e.methods,this._routes=e.routes,this._dirs=e.dirs,this._computed=e.computed,this._eventInfos=[],this._watchers=[],this._children=[],this._routeEl=null,this._comCollection=[],this._unlinked=!1,this._initLifeCycleHooks(e),this._bootstrap(),this._routes&&(this._routeTplStore=Object.create(null),v(this)),Z.registeredTagsCount>0&&this._comCollection.length>0&&(this._comTplStore=Object.create(null),this._renderComponent()),this.created&&this.created.call(this),this._bindEvents()};return Oe.prototype._initLifeCycleHooks=function(e){var t,n=this;Object.keys(e).forEach(function(r){Ce.indexOf(r)>-1&&(t=e[r],"function"==typeof t&&(n[r]=t))})},Oe.prototype._bindEvents=function(){this._eventInfos.forEach(function(e){return e.el.addEventListener(e.name,e.handler,!1)})},Oe.prototype._unbindEvents=function(){this._eventInfos.forEach(function(e){return e.el.removeEventListener(e.name,e.handler,!1)}),this._eventInfos.length=0},Oe.prototype._bootstrap=function(){J(this.model),this._addComputed(),this._compileDOM(),this._watchers.forEach(function(e){return e.update()}),this._methods&&a(this.model,this._methods,!0)},Oe.prototype._addComputed=function(){var e,t=this;for(var n in this._computed)if(e=t._computed[n],"function"==typeof e)Object.defineProperty(t.model,n,{enumerable:!0,get:t._makeComputedGetter(e)});else{var r={enumerable:!0};"function"==typeof e.get&&(r.get=t._makeComputedGetter(e.get)),"function"==typeof e.set&&(r.set=e.set),Object.defineProperty(t.model,n,r)}},Oe.prototype._makeComputedGetter=function(e){var t=pe.get(e,this,null).getDeps();return function(){return(t.dirty||pe.target)&&(t.getValue(),t.dirty=!1),t.value}},Oe.prototype._renderComponent=function(){var e=this;u(this._comCollection,function(t){Q(e,t)})},Oe.prototype.watch=function Ae(Ae,e,t){pe.get(Ae,this,e,t).getDeps()},Oe.prototype._compileDOM=function(){this._dirs?R(this.el,this):z(this,this.el)},Oe.prototype.unlink=function(){this._unlinked||(this._unlinked=!0,this._comCollection.length=0,this._children.forEach(function(e){return e.unlink()}),this._watchers.forEach(function(e){return e.dead=!0}),this._unbindEvents(),this.model=null)},Y.filter=function(e,t){oe[e]||"function"!=typeof t||(oe[e]=t)},Y.com=K,Y});