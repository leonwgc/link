!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.link=t()}(this,function(){"use strict";function e(e){return!!e&&"object"==typeof e}function t(e){return"function"==typeof e}function n(e){return"string"==typeof e}function r(e){return"boolean"==typeof e}function i(e){return n(e)&&"{"===e[0]&&"}"===e[e.length-1]}function o(e,t){e.className.indexOf(t)===-1&&(e.className=u(e.className)+" "+t)}function s(e,t){e.className.indexOf(t)>-1&&(e.className=e.className.replace(new RegExp(t,"g"),""))}function u(e){return"string"==typeof e?e.trim():e}function l(e,t){for(var n=e.length,r=-1;++r<n;)t(e[r],r,e)}function a(e,t,n){return l(Object.keys(t),function(r){e[r]&&n||(e[r]=t[r])}),e}function c(e,t,n){var r=e[t];if(r)n(r);else{var i=new XMLHttpRequest;i.onreadystatechange=function(){i.readyState===XMLHttpRequest.DONE&&200===i.status&&(e[t]=u(i.responseText),n(i.responseText))},i.open("GET",t,!0),i.setRequestHeader("Accept","text/html"),i.send(null)}}function h(e){var t=e.split("."),n=t.length,r=t[n-1];return function(e,i){for(var o=e,s=0;s<n-1;s++)o=o[t[s]];return 1===arguments.length?o[r]:void(o[r]=i)}}function f(e,t){return ae[t]||(ae[t]=d(t))}function d(e){return new Function("t","with(t){ return "+e+";}")}function p(e){if("undefined"==typeof e){var t=location.href,n=t.indexOf("#");return n===-1?"":t.slice(n+1)}location.hash=e}function m(e){var t=location.href,n=t.indexOf("#");n>-1?location.replace(t.slice(0,n)+"#"+e):location.replace(t+"#"+e)}function v(e){function t(){var t=n[p()];if(!t)return void m(r);var i=u(t.template);i?y(e,t,i):t.templateUrl?c(e._routeTplStore,t.templateUrl,function(n){y(e,t,n)}):y(e,t,"")}var n=e._routes.routes,r=e._routes.defaultPath;e._eventInfos.unshift({el:window,name:"hashchange",handler:t}),t()}function y(e,t,n){he&&(he.unlink(),he=void 0),e._routeEl&&(e._routeEl.innerHTML=n),he=new Se(a({el:e._routeEl},t,!0))}function g(e,t){function n(){e.setPath(e.el.value)}e.linker._eventInfos.unshift({el:e.el,name:t,handler:n})}function b(e){function t(){var t,i=n.value,o=n.checked,s=e.watcher.value;if(r(s))e.setPath(o);else{if(!Array.isArray(s))throw new Error("checkbox should bind with array or boolean value");t=s.indexOf(i),!o&&t>-1?s.splice(t,1):s.push(i)}}var n=e.el;e.linker._eventInfos.unshift({el:n,name:"click",handler:t})}function _(e){var t=e.el,n=t.nodeName,r=t.type;if("INPUT"===n)switch(r){case"text":case"password":g(e,"keyup");break;case"radio":g(e,"click");break;case"checkbox":b(e);break;default:g(e,"keyup")}else"SELECT"===n?g(e,"change"):g(e,"keyup")}function w(e){this.el.textContent=e}function k(e){this.className?e?o(this.el,this.className):s(this.el,this.className):e&&o(this.el,e)}function x(e){e?this.el.setAttribute("disabled","disabled"):this.el.removeAttribute("disabled")}function E(e){var t=this.el;if("radio"===t.type){var n=t.value===e;t.checked!=n&&(t.checked=n)}else if("checkbox"===t.type)if(Array.isArray(e))t.checked=e.indexOf(t.value)>-1;else{if(!r(e))throw Error("checkbox should bind with array or a boolean value");t.checked!==e&&(t.checked=e)}else t.value!=e&&(t.value=e)}function A(e){e?this.el.setAttribute("readonly","readonly"):this.el.removeAttribute("readonly")}function C(e){return fe.indexOf(typeof e)>-1}function O(e,t,n,r,i){var o,s=e.linker.model,u=Object.create(null),l=e.dirs;return l||(e.dirs=l=[],V(e.linker,r,l)),u.$index={value:n,enumerable:!0,configurable:!0,writable:!0},u[e["var"]]={value:t,enumerable:!0,configurable:!0,writable:!0},o=new Se({el:r,model:Object.create(s,u),dirs:l.slice()}),e.linker._children.push(o),o}function j(e,t,n){function r(){for(var e=d.length;e--;)if(f.indexOf(d[e])===-1)return d[e]}function i(){var e,t,n,i=u.length,s=f.length;if(!i)return void(s&&(l(f,function(e){p.removeChild(e.el),m||e.unlink()}),f.length=0));if(m)if(s>=i){l(u,function(e,t){f[t].model[a]=e});for(var c=i;c<s;c++)p.removeChild(f[c].el);f.length=i}else{t=document.createDocumentFragment(),n=d.length,l(f,function(e,t){e.model[a]=u[t]});var v=s;if(n>s)do e=r(),e.model[a]=u[v++],f.push(e),t.appendChild(e.el);while(n>f.length&&v<i);for(;v<i;)o(u[v],v++,m,t)}else t=document.createDocumentFragment(),l(f,function(e){p.removeChild(e.el),e.unlink()}),f.length=0,l(u,function(e,n){o(e,n,m,t)});t&&p.insertBefore(t,h)}function o(e,t,n,r,i){var o=O(s,e,t,c.cloneNode(!0),n);return i||f.push(o),n&&d.push(o),r&&r.appendChild(o.el),o}if(!n||"mutate"!==n.op){var s=this,u=e,a=this["var"],c=this.el,h=this.comment,f=this.lastLinkers,d=this.allLinkers,p=c.parentNode||h.parentNode,m=this.valIsPrimitive;if("undefined"==typeof m&&u.length&&(m=this.valIsPrimitive=C(u[0])),f||(f=this.lastLinkers=[],d=this.allLinkers=[],h=this.comment=document.createComment(""+a),p.insertBefore(h,c),p.removeChild(c)),n){var v,y,g=n.op,b=n.args,_=t===e;switch(g){case"push":(_||e.length>t.length)&&(v=u.length-1,y=o(u[v],v,m),p.insertBefore(y.el,h));break;case"pop":(_||e.length<t.length)&&(y=f.pop(),p.removeChild(y.el),m||y.unlink());break;case"splice":y=Array.prototype.splice.apply(f,b),l(y,function(e){p.removeChild(e.el),m||e.unlink()}),l(f,function(e,t){e.model.$index=t});break;case"unshift":(_||e.length>t.length)&&(y=o(u[0],0,m,null,!0),p.insertBefore(y.el,f[0].el),f.unshift(y));break;case"shift":(_||e.length<t.length)&&(y=f.shift(),p.removeChild(y.el),m||y.unlink());break;default:i()}}else i()}}function T(e){return function(t){var n=this.el;e&&t||!e&&!t?(s(n,"x-hide"),n.style.display=""):(o(n,"x-hide"),n.style.display="none")}}function N(e){this.el.setAttribute(this.directive,e)}function S(e){e&&"object"==typeof e&&(Array.isArray(e)?e.forEach(function(e){return S(e)}):Object.keys(e).forEach(function(t){return S(e[t])}))}function P(e,t){return e.replace(re,function(e,n){return I(n,t)})}function L(e,t){return I(e,t)}function I(e,t){var n,r,i=e.split("|");return 1===i.length?f(t,e)(t):(r=i[0].trim(),n=i[1].trim(),le[n](f(t,r)(t)))}function D(e,t){return t?ke.test(e):H(e)}function H(e){if(e.indexOf("|")===-1)return!1;for(var t,n,r=e.length,i=0;i<r;)if(t=e[i],'"'===t||"'"===t){for(n=i+1;n<r&&e[n]!==t;)++i;if(!(i<r))throw new Error("bad text");i+=2}else if("|"===t){if(n=i+1,n<r&&e[n]!==t)return!0;i+=2}else++i;return!1}function U(e,t){return function(n){return t?P(e,n):L(e,n)}}function $(e){var t=me[e.isAttrDir?se:e.directive];return function(n,r,i){return t.call(e,n,r,i)}}function M(e){var t=h(e);return function(e){return t(this.linker.model,e)}}function q(e){return Ce[e]||(Ce[e]=new Function("m","$event","$el","with(m){"+e+"}"))}function B(e,t,n){var r=q(e);return function(e){r(t,e,n)}}function F(e,t,n,r){return Ae.create(t,"x-bind",null,n,e,r)}function G(e,t,n,r,i){var o,s=r.slice(1,-1).split(","),u=[];return l(s,function(r){o=r.split(":");var s=Ae.create(t,n,o[1].trim(),null,e,i);s.className=o[0].trim(),u.push(s)}),u}function R(e,t,n,r,o){var s,u=[];return i(r)?(s=G(e,t,n,r,o),u=u.concat(s)):(s=Ae.create(t,n,r,null,e,o),u.push(s)),u}function z(e,t){if(t._dirs.length){var n=t._dirs.shift();n&&l(n,function(n){n instanceof Ae?n.clone(e,t):t._eventInfos.push({el:e,name:n.name,handler:B(n.expr,t.model,e)})}),1===e.nodeType&&l(e.childNodes,function(e){z(e,t)})}}function V(e,t,n){var r,i,o,s,a,c,h,f,d=t.nodeType,p=[];if(1===d){if(a=t.hasAttributes()){if(t.hasAttribute("x-for")){if(i=u(t.getAttribute("x-for")),o=i.split(ie),f=o.length,3!==f&&6!==f)throw new Error("repeat only support expr like: var in array [track by expr].");return t.removeAttribute("x-for"),s=Ae.create(t,"x-for",o[2],null,e,n),s["var"]=o[0],6===f&&(s.trackBy=o[5].slice(o[5].indexOf(".")+1)),void(n&&(p.push(s),n.push(p)))}if(t.hasAttribute("x-view")){if(e._routeEl)throw new Error("a link context can only have on more than one x-view");return t.removeAttribute("x-view"),void(e._routeEl=t)}l(t.attributes,function(r){if(c=r.name,h=r.value.trim(),me[c]){var i=R(e,t,c,h,n);n&&(p=p.concat(i))}else{var o=c[0];o===oe?n?p.push({name:c.slice(1),expr:h}):e._eventInfos.push({el:t,name:c.slice(1),handler:B(h,e.model,t)}):o===se&&(s=Ae.create(t,c.slice(1),h,null,e,n,!0),n&&p.push(s))}})}if(te.registeredTagsCount>0&&(r=t.tagName.toUpperCase(),te.registeredTags[r]))return void e._comCollection.push({el:t,config:te.registeredTags[r]});n&&n.push(p.length?p:null),l(t.childNodes,function(t){V(e,t,n)})}else 3===d?(i=t.textContent.trim(),i.length&&ne.test(i)&&p.push(F(e,t,i,n)),n&&n.push(p.length?p:null)):9===d&&l(t.childNodes,function(t){V(e,t)})}function X(e,t,n){var r=K(n)||new je;Object.defineProperty(e,t,{get:function(){var e=be.target;return e&&r.addSub(e),n},set:function(e){if(e!==n){if(e!==e&&n!==n)return;if(n=e,"object"==typeof e&&e){var t=r;r=K(e),t.notify(Array.isArray(e))}else r.notify()}}})}function J(e){l(ue,function(t){e[t]=function(n){var r,i=Te.call(arguments),o=1===i.length?Array.prototype[t].call(e,n):Array.prototype[t].apply(e,i);switch(t){case"push":r=i;break;case"unshift":r=i;break;case"splice":r=i.slice(2)}return r&&r.forEach(function(e){return K(e)}),e.__dep__.notify({op:t,args:i}),o}})}function K(e){if(e&&"object"==typeof e){if(e.hasOwnProperty("__dep__")&&e.__dep__ instanceof je)return e.__dep__;var t=new je;return Object.defineProperty(e,"__dep__",{value:t}),Array.isArray(e)?(J(e),e.forEach(function(e){return K(e)})):Object.keys(e).forEach(function(t){return X(e,t,e[t])}),t}}function Q(e){var t=e.tag;if(!t)throw new Error("tag is required for a component!");t=t.toUpperCase(),te.registeredTags[t]||(te.registeredTags[t]=e,++te.registeredTagsCount)}function W(e,t){var n=t.config,r=u(n.template),i=t.el;r?Y(e,i,n,r):n.templateUrl&&c(e._comTplStore,n.templateUrl,function(t){Y(e,i,n,t)})}function Y(e,n,r,i){if(n.innerHTML=i,n.children.length>1)throw new Error("component can only have one root element");var o=a({},r);if(o.model&&"function"!=typeof o.model)throw new Error("component model must be a function to return a model data");var s=o.model=o.model(),u=o.methods||{};if(o.el=n.children[0],Array.isArray(o.props)){var l,c;o.props.forEach(function(r){l=n.getAttribute(r).trim(),t(e.model[l])?u[r]=e.model[l]:(c=h(l)(e.model),c!==s[r]&&(s[r]=c),e.watch(l,function(e){s[r]=e}))})}e._children.push(new Se(o))}function Z(t){if(!e(t))throw new Error("config must be an object.");return t.el||(t.el=window.document),new Se(t)}var ee,te={registeredTagsCount:0,registeredTags:Object.create(null)},ne=/\{\{[^\}]+\}\}/,re=/\{\{([^\}]+)\}\}/g,ie=/\s+/,oe="@",se=":",ue=["push","pop","unshift","shift","reverse","sort","splice"],le=Object.create(null),ae=Object.create(null);if("undefined"!=typeof Promise&&"function"==typeof Promise.resolve){var ce=Promise.resolve();ee=function(e){return ce.then(e)["catch"](function(e){throw e})}}else ee=function(e){setTimeout(e,0)};var he,fe=["string","number","boolean"],de=T(!0),pe=T(!1),me={"x-show":de,"x-hide":pe,"x-bind":w,"x-disabled":x,"x-for":j,"x-class":k,"x-model":E,"x-readonly":A,":":N},ve=/^[\w$]+(\.[\w$]+)*$/,ye=0,ge={op:"mutate"},be=function(e,t,n,r){this.id=++ye,this.getter="function"==typeof e?e:ve.test(e)?h(e):f(t.model,e),this.linker=t,this.model=t.model,this.deep=r,this.lazy=!n,this.cb=n};be.prototype.getDeps=function(){return be.target=this,this.value=this.getter.call(this.model,this.model),this.deep&&S(this.value),be.target=null,this},be.prototype.getValue=function(){this.value=this.getter.call(this.model,this.model)},be.prototype.update=function(e){if(this.lazy)return void(this.dirty=!0);var t=this.value;this.getDeps(),t!==this.value||e?this.cb.call(this.model,this.value,t,e):Array.isArray(this.value)&&this.cb.call(this.model,this.value,t,ge)},be.prototype.updateAsync=function(){be.run(this)},be.get=function(e,t,n,r){return new be(e,t,n,r)},be.target=null;var _e=[],we=!1;be.run=function(e){return link.sync?void e.update():void(e.waiting||(e.waiting=!0,_e.push(e),we||(we=!0,ee(function(){for(var e,t=0;t<_e.length;t++)e=_e[t],e.waiting=!1,e.update();_e.length=0,we=!1}))))};var ke=/\{\{[^\}\|]+\|[^\}\|]+\}\}/,xe=/(\{\{)/g,Ee=/(\}\})/g,Ae=function(e,t,n,r){this.el=e,this.directive=t,this.linker=n,this.isAttrDir=r};Ae.prototype.clone=function(e,t){var n=new Ae(e,this.directive,t);return a(n,this,!0),n.watcher=be.get(this.watcher.getter,t,$(n)),t._watchers.push(n.watcher),"x-model"===this.directive&&_(n),n},Ae.create=function(e,t,n,r,i,o,s){var u="x-model"===t,l=new Ae(e,t,i,s);return r?l.watcher=be.get(D(r,!0)?U(r,!0):('"'+r+'"').replace(xe,'"+(').replace(Ee,')+"'),i,$(l)):l.watcher=be.get("x-bind"!==t?n:U(n,!1),i,$(l)),u&&(l.setPath=M(n)),o||(u&&_(l),i._watchers.push(l.watcher)),l};var Ce=Object.create(null),Oe=0,je=function(){this.id=++Oe,this.has=Object.create(null),this.subs=[],this.deadSubs=[]};je.prototype.addSub=function(e){this.has[e.id]||(this.has[e.id]=!0,this.subs.push(e))},je.prototype.removeSub=function(e){this.has[e.id]&&delete this.has[e.id];var t=this.subs.indexOf(e);t>-1&&this.subs.splice(t,1)},je.prototype.notify=function(e){var t=this;this.subs.forEach(function(n){n.dead?t.deadSubs.push(n):e?n.update(e):n.updateAsync()}),this.deadSubs.length&&(this.deadSubs.forEach(function(e){return t.removeSub(e)}),this.deadSubs.length=0)};var Te=Array.prototype.slice,Ne=["created"],Se=function(e){this.el=n(e.el)?document.querySelector(e.el):e.el,this.model=e.model||{},this._methods=e.methods,this._routes=e.routes,this._dirs=e.dirs,this._computed=e.computed,this._eventInfos=[],this._watchers=[],this._children=[],this._routeEl=null,this._comCollection=[],this._unlinked=!1,this._initLifeCycleHooks(e),this._bootstrap(),this._routes&&(this._routeTplStore=Object.create(null),v(this)),te.registeredTagsCount>0&&this._comCollection.length>0&&(this._comTplStore=Object.create(null),this._renderComponent()),"function"==typeof this.created&&this.created(),this._bindEvents()};return Se.prototype._initLifeCycleHooks=function(e){var t,n=this;Object.keys(e).forEach(function(r){Ne.indexOf(r)>-1&&(t=e[r],"function"==typeof t&&(n[r]=t))})},Se.prototype._bindEvents=function(){this._eventInfos.forEach(function(e){return e.el.addEventListener(e.name,e.handler,!1)})},Se.prototype._unbindEvents=function(){this._eventInfos.forEach(function(e){return e.el.removeEventListener(e.name,e.handler,!1)}),this._eventInfos.length=0},Se.prototype._bootstrap=function(){K(this.model),this._addComputed(),this._compileDOM(),this._watchers.forEach(function(e){return e.update()}),this._methods&&a(this.model,this._methods,!0)},Se.prototype._addComputed=function(){var e,t=this;for(var n in this._computed)if(e=t._computed[n],"function"==typeof e)Object.defineProperty(t.model,n,{enumerable:!0,get:t._makeComputedGetter(e)});else{var r={enumerable:!0};"function"==typeof e.get&&(r.get=t._makeComputedGetter(e.get)),"function"==typeof e.set&&(r.set=e.set),Object.defineProperty(t.model,n,r)}},Se.prototype._makeComputedGetter=function(e){var t=be.get(e,this,null).getDeps();return function(){return(t.dirty||be.target)&&(t.getValue(),t.dirty=!1),t.value}},Se.prototype._renderComponent=function(){var e=this;l(this._comCollection,function(t){W(e,t)})},Se.prototype.watch=function Pe(Pe,e,t){be.get(Pe,this,e,t).getDeps()},Se.prototype._compileDOM=function(){this._dirs?z(this.el,this):V(this,this.el)},Se.prototype.unlink=function(){this._unlinked||(this._unlinked=!0,this._comCollection.length=0,this._children.forEach(function(e){return e.unlink()}),this._watchers.forEach(function(e){return e.dead=!0}),this._unbindEvents(),this.model=null)},Z.filter=function(e,t){le[e]||"function"!=typeof t||(le[e]=t)},Z.com=Q,Z});