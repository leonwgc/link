
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.link=t()}(this,function(){"use strict";function e(e){return!!e&&"object"==typeof e}function t(e){return"function"==typeof e}function n(e){return"string"==typeof e}function i(e){return"boolean"==typeof e}function r(e){return n(e)&&"{"===e[0]&&"}"===e.slice(-1)}function o(e,t){e.className.indexOf(t)===-1&&(e.className=a(e.className)+" "+t)}function l(e,t){e.className.indexOf(t)>-1&&(e.className=e.className.replace(new RegExp(t,"g"),""))}function s(){if(arguments.length<2)return arguments[0];var e=arguments[0],t=Array.prototype.slice.call(arguments,1);return e.replace(/\{(\d+)\}/g,function(e,n){return t[n]})}function a(e){return"string"==typeof e?e.trim():e}function c(e,t){for(var n=e.length,i=-1;++i<n;)t(e[i],i,e)}function u(e,t){return c(Object.keys(t),function(n){e[n]=t[n]}),e}function h(e,t,n,i){e.addEventListener&&(e.addEventListener(t,n,!1),i.push({el:e,event:t,handler:n}))}function f(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)}function p(e,t,n){var i=e[t];if(i)n(i);else{var r=new XMLHttpRequest;r.onreadystatechange=function(){r.readyState===XMLHttpRequest.DONE&&200===r.status&&(e[t]=a(r.responseText),n(r.responseText))},r.open("GET",t,!0),r.setRequestHeader("Accept","text/html"),r.send(null)}}function d(t){if(e(t)){var n,i={};return c(Object.keys(t),function(r){n=t[r],Y(n)?(i[r]=[],c(n,function(e){i[r].push(d(e))})):e(n)?i[r]=d(n):i[r]=n}),i}return t}function m(e){var t=0;return function(){t&&clearTimeout(t),t=setTimeout(e,0)}}function v(){}function x(e,t){return function(){return e.apply(t,arguments)}}function _(e){if("undefined"==typeof e){var t=location.href,n=t.indexOf("#");return n===-1?"":t.slice(n+1)}location.hash=e}function k(e){var t=location.href,n=t.indexOf("#");n>-1?location.replace(t.slice(0,n)+"#"+e):location.replace(t+"#"+e)}function w(t,n,i){function r(){var r=n[_()];if(!r)return void k(i);r.model&&e(r.model)||(r.model={});var o=a(r.template);o?y(t,r,o):r.templateUrl?p(t._routeTplStore,r.templateUrl,function(e){y(t,r,e)}):y(t,r,"")}h(window,"hashchange",r,t._eventStore),r()}function y(e,n,i){function r(){e._routeEl&&(n.lastLinker=Q({el:e._routeEl,model:n.model,methods:n.methods}),t(n.postLink)&&n.postLink.call(n,n.lastLinker))}var o;if(e._routeEl&&(e._routeEl.innerHTML=i),n.lastLinker&&n.lastLinker.unlink(),t(n.preLink)&&(o=n.preLink.call(n,e)),o&&t(o.then))o.then(r);else{if(o===!1)return;r()}}function b(){var e=s.apply(null,arguments);return new Error(e)}function g(e){if(!Number(e))return e;e+="";var t=[],n="",i=-1,r=[],o=",";(i=e.indexOf("."))>-1?(t=e.slice(0,i).split(""),n=e.slice(i)):t=e.split("");do r.unshift(t.splice(-3).join(""));while(t.length>0);return r.join(o)+n}function C(e){return n(e)&&11===e.length?e.slice(0,3)+"****"+e.slice(-4):e}function O(e,t){return new Function("$this","with($this){return "+e+";}")(t)}function T(e,t,n){var i,r=e.expr,o=e.linker.model;return i=n?t?n.replace(ce,function(e,t){return N(t,o)}):O(r,o):t?N(r,o):O(r,o)}function N(e,t){var n=e.split("|");if(1===n.length)return O(e,t);var i=fe[a(n[1])];return i(O(a(n[0]),t))}function j(e,t,n,i){if(i){var r=i._watchSetterCache[e];r||(r=i._watchSetterCache[e]=new Function("m","v","with(m){"+e+"=v;}")),r(n,t)}else new Function("m","v","with(m){"+e+"=v;}")(n,t)}function A(e){var t=e.tag;if(!t)throw b("tag is required for a component!");t=t.toUpperCase(),se.registeredTags[t]||(se.registeredTags[t]=e,++se.registeredTagsCount)}function E(e,t){var n=t.config,i=a(n.template),r=t.el;i?S(e,r,n,i):n.templateUrl&&p(e._comTplStore,n.templateUrl,function(t){S(e,r,n,t)})}function L(e,t,n,i){return function(){j(e,O(t,i),n)}}function S(e,n,i,r){var o=d(i.model),l=i.methods||{};if(Y(i.props)){var s;c(i.props,function(i){if(s=a(n.getAttribute(i)),t(e.model[s]))l[i]=e.model[s];else{e.watch(s,L(i,s,o,e.model),!0);var r=O(s,e.model);r!==o[i]&&(o[i]=r)}})}if(n.innerHTML=r,n.children.length>1)throw b("component can only have one root element");var u=Q({el:n.children[0],model:o,methods:l});t(i.postLink)&&i.postLink.call(u.model,n,u,i)}function M(e,t,n){e.el.textContent=T(e,t,n)}function $(e){var t=e.exprVal;e.className?t?o(e.el,e.className):l(e.el,e.className):t&&o(e.el,t)}function F(e){e.exprVal?e.el.setAttribute("disabled","disabled"):e.el.removeAttribute("disabled")}function V(e){var t=e.el,n=e.exprVal;if("radio"===t.type)t.checked=t.value===n;else if("checkbox"===t.type)if(Y(n))t.checked=n.indexOf(t.value)>-1;else{if(!i(n))throw b("checkbox should bind with array or a boolean value");t.checked=n}else t.value!=n&&(t.value=n)}function U(e){e.exprVal?e.el.setAttribute("readonly","readonly"):e.el.removeAttribute("readonly")}function B(e,t,n,i){var r,o=e.el.cloneNode(!0),l=e.linker.model,s=Object.create(null);return s.$index={value:n,enumerable:!0,configurable:!0,writable:!0},s[i]={value:t,enumerable:!0,configurable:!0,writable:!0},r=new ke(o,Object.create(l,s)),r._context=e,e.linker._children.push(r),{el:o,linker:r}}function P(e,t){function n(){var t=document.createDocumentFragment();e.linker._children.length=0,c(s,function(e){e.unlink()}),s.length=0,c(r,function(n,r){i=B(e,n,r,a),s.push(i.linker),t.appendChild(i.el)}),l.parentNode.insertBefore(t,l)}var i,r=e.exprVal,o=e.el,l=e.comment,s=e.lastLinks,a=e.expr.split(ue)[0];if(s||(s=e.lastLinks=[],l=e.comment=document.createComment("repeat end for "+e.prop),o.parentNode.insertBefore(e.comment,o),o.parentNode.removeChild(o)),t){var u,h,f,p=t.op;switch(p){case"mutate":break;case"push":h=r.length-1,u=r[h],i=B(e,u,h,a),s.push(i.linker),l.parentNode.insertBefore(i.el,l);break;case"pop":f=s.pop(),f.unlink();break;case"splice":f=Array.prototype.splice.apply(s,t.args),c(f,function(e){e.unlink()}),c(s,function(e,t){e.model.$index=t});break;case"unshift":var d=s[0].el;u=r[0],i=B(e,u,0,a),s.unshift(i.linker),d.parentNode.insertBefore(i.el,d);break;case"shift":f=s.shift(),f.unlink();break;default:n()}}else n()}function W(e){var t=e.el,n=e.directive,i=!!e.exprVal;"x-show"===n&&i||"x-hide"===n&&!i?l(t,"x-hide"):o(t,"x-hide")}function z(e,t){function n(){j(e.prop,i.value||"",e.linker.model,e.linker)}var i=e.el;h(i,t,n,e.linker._eventStore)}function H(e){function t(){var t,r=n.value,o=n.checked,l=e.exprVal;if(!i(l)&&!Y(l))throw b("checkbox should bind with array or a boolean value");Y(l)?(t=l.indexOf(r),!o&&t>-1?l.splice(t,1):l.push(r)):j(e.prop,o,e.linker.model,e.linker)}var n=e.el;h(n,"click",t,e.linker._eventStore)}function Z(e){var t=e.el,n=t.nodeName,i=t.type;switch(n){case"INPUT":switch(i){case"text":case"email":case"password":case"url":z(e,"keyup");break;case"radio":z(e,"click");break;case"checkbox":H(e)}break;case"SELECT":z(e,"change");break;default:z(e,"keyup")}}function q(e,t){return function(n){var i=t.el,r=t.fn,o=t.args;if(null===r)O(o,e.model);else if(e.model[r])if(Y(o)){var l=[];c(o,function(t){t=t.trim(),ee.test(t)?l.push(O(t,e.model)):"'"===t[0]||'"'===t[0]?l.push(t.replace(re,"")):l.push(t)}),e.model[r].apply(e.model,l.concat(n,i))}else e.model[r].apply(e.model,[n,i])}}function D(e,t,n){var i=['"',n,'"'].join("").replace(/(\{\{)/g,'"+(').replace(/(\}\})/g,')+"'),r=new xe(i);r.run(),r.watches&&c(r.watches,function(o){var l=de.create(t,o,"x-bind",i,e);l.text=n,l.filters=r.filters})}function R(e,t,n,i,r){var o=de.create(t,n,i,r,e);"x-model"===i&&Z(o)}function X(e,t,n,i){var r,o,l;te.test(i)?r=ve.create(t,n,i):ne.test(i)?(o=i.indexOf("("),r=ve.create(t,n,i.slice(0,o))):ie.test(i)?(l=i.match(ie)[1].split(","),o=i.indexOf("("),r=ve.create(t,n,i.slice(0,o),l)):r=ve.create(t,n,null,i),h(t,n,q(e,r),e._eventStore)}function G(e,t,n,i){var r,o,l,s,a,u=i.slice(1,-1).split(",");c(u,function(i){l=i.split(":"),r=l[0].replace(re,"").trim(),o=l[1].trim(),ee.test(o)?(a=de.create(t,o,n,o,e),a.className=r):(s=new xe(o),s.run(),s.watches&&c(s.watches,function(i){a=de.create(t,i,n,o,e),a.className=r}))})}function I(e,t,n,i){var o;if(ee.test(i))R(e,t,i,n,i);else if(r(i))G(e,t,n,i);else{var l=new xe(i);l.run(),l.watches&&c(l.watches,function(r){o=de.create(t,r,n,i,e),o.filters=l.filters})}}function J(e,t){var n,i,r,o,l,s,u=t.nodeType;if(1===u){if(o=t.hasAttributes()){if(t.hasAttribute("x-repeat")){if(i=a(t.getAttribute("x-repeat")),r=i.split(ue),3!==r.length)throw b("repeat only support expr like: var in array.");return R(e,t,r[2],"x-repeat",i),t.removeAttribute("x-repeat"),void(e._children=[])}if(t.hasAttribute("x-view")){if(e._routeEl)throw b("a link context can only have on more than one x-view");return t.removeAttribute("x-view"),void(e._routeEl=t)}c(t.attributes,function(n){l=n.name,s=a(n.value),"x"===l[0]&&"-"===l[1]?I(e,t,l,s):l[0]===he&&X(e,t,l.slice(1),s)})}if(se.registeredTagsCount>0&&(n=t.tagName.toUpperCase(),se.registeredTags[n]))return void e._comCollection.push({el:t,config:se.registeredTags[n]});c(t.childNodes,function(t){J(e,t)})}else 3===u?(i=a(t.textContent),i&&ae.test(i)&&D(e,t,i)):9===u&&c(t.childNodes,function(t){J(e,t)})}function K(e,t,n){c(["push","pop","unshift","shift","reverse","sort","splice"],function(i){e[i]=function(){var r=Array.prototype[i].apply(e,arguments);return n._notify(t,{op:i,args:arguments}),n._notify(t+".length"),r}})}function Q(e){return e=u({el:window.document,model:{},methods:null,routes:null},e),new ke(e.el,e.model,e.methods,e.routes)}var Y=Array.isArray;v="undefined"!=typeof Promise&&Promise.resolve?function(e){Promise.resolve().then(e)["catch"](function(e){throw e})}:function(e){setTimeout(e,0)};var ee=/^\$?\w+(\.?\w+)*$/,te=/^[a-zA-Z$_]\w*$/,ne=/^[a-zA-Z$_]\w*\(\s*\)$/,ie=/^[a-zA-Z$_]\w*\(([^\)]+)\)$/,re=/[\'\"]/g,oe=/[a-zA-Z$_]/,le=/[a-zA-Z0-9$\.]/,se={registeredTagsCount:0,registeredTags:Object.create(null)},ae=/\{\{[^\}]+\}\}/,ce=/\{\{([^\}]+)\}\}/g,ue=/\s+/,he="@",fe={uppercase:function(e){return n(e)?e.toUpperCase():e},lowercase:function(e){return n(e)?e.toLowerCase():e},money:g,phone:C},pe={"x-show":W,"x-hide":W,"x-bind":M,"x-disabled":F,"x-repeat":P,"x-class":$,"x-model":V,"x-readonly":U},de=function(e,t,n,i,r){this.el=e,this.prop=t,this.directive=n,this.expr=i,this.linker=r,this.filters=null,this.text=null,this._evalExprFn=x(new Function("with(this){return "+("x-repeat"!==n?i:t)+";}"),r.model)},me={exprVal:{}};de.create=function(e,t,n,i,r){var o,l=r._watchMap;return l[t]||(l[t]=[]),o=new de(e,t,n,i,r),l[t].push(x(o.update,o)),o},me.exprVal.get=function(){return this._evalExprFn()},de.prototype.update=function(e){"x-bind"!==this.directive?pe[this.directive](this,e):pe[this.directive](this,this.filters,this.text)},Object.defineProperties(de.prototype,me);var ve=function(e,t,n,i){this.el=e,this.event=t,this.fn=n,this.args=i};ve.create=function(e,t,n,i){return new ve(e,t,n,i)};var xe=function(e){this.text=e,this.index=0,this.len=e.length,this.watches=null,this.filters=null};xe.prototype.run=function(){for(var e=this;this.index<this.len;){var t=e.text[e.index];if(oe.test(t))e.watches||(e.watches=[]),e._getWatch(t);else if('"'===t||"'"===t){for(;this._peek()!==t&&this.index<this.len;)e.index++;if(!(e.index+1<e.len))throw new Error("unclosed string in expr");e.index+=2}else if("|"===t)if("|"!==e._peek()){if(e.filters||(e.filters=[]),e.index++,e.watches.length<e.filters.length)throw new Error("bad expr");e._getFilter()}else e.index+=2;else e.index++}},xe.prototype._getFilter=function(){for(var e=this,t=[this.text[this.index]];this.index<this.len;){if(!le.test(e._peek())){e.index++;break}t.push(e.text[++e.index])}this.filters.push(a(t.join("")))},xe.prototype._getWatch=function(e){for(var t=this,n=[e];this.index<this.len;){if(!le.test(t._peek())){t.index++;break}n.push(t.text[++t.index])}this.watches.push(n.join(""))},xe.prototype._peek=function(e){return e=e||1,this.index+e<this.len&&this.text[this.index+1]};var _e=Array.prototype.push,ke=function(e,t,n,i){this.el=e,this.model=t,this._behaviors=n,this._eventStore=[],this._userWatchMap=Object.create(null),this._watchMap=Object.create(null),this._routeEl=null,this._comCollection=[],this._unlinked=!1,this._children=null,this._context=null,this._watchSetterCache=Object.create(null),this._bootstrap(),i&&(this._routeTplStore=Object.create(null),w(this,i.routes,i.defaultPath)),se.registeredTagsCount>0&&this._comCollection.length>0&&(this._comTplStore=Object.create(null),this._renderComponent())};ke.prototype._bootstrap=function(){var e=this;this._compileDOM(),this._walk(this.model,[]),c(Object.keys(this._watchMap),function(t){e._notify(t)}),this._addBehaviors()},ke.prototype._walk=function(t,n){var i,r,o,l=this;c(Object.keys(t),function(s){i=t[s],r=Y(i),e(i)&&!r?(n.push(s),l._walk(i,n),n.pop()):(o=n.concat(s).join("."),l._defineObserver(t,s,i,o,r))})},ke.prototype._defineObserver=function(e,t,n,i,r){var o=this;r&&K(n,i,o),Object.defineProperty(e,t,{get:function(){return n},set:function(e){if(e!==n){if(r?(n.length=0,e.length&&_e.apply(n,e),o._notify(i+".length")):n=e,o._unlinked)return;o._notify(i),o._context&&o._context.linker._notify(o._context.prop,{op:"mutate"}),o._children&&v(function(){c(o._children,function(e){e._unlinked||e._notify(i)})})}}})},ke.prototype._addBehaviors=function(){var n=this;if(e(this._behaviors)){var i=Object.keys(this._behaviors);c(i,function(e){if(t(n._behaviors[e])){if(e in n.model&&!t(n.model[e]))throw b('{0} is defined in the data model,please change the function/method name of "{0}"',e);n.model[e]||(n.model[e]=n._behaviors[e])}})}},ke.prototype._renderComponent=function(){var e=this;c(this._comCollection,function(t){E(e,t)})},ke.prototype.watch=function ye(ye,e,i){if(n(ye)&&""!==ye.trim()&&t(e)){var r=this._userWatchMap[ye];r||(r=this._userWatchMap[ye]=[]),r.push(i?e:m(e))}},ke.prototype._notify=function(e,t){if(!this._unlinked){var n=this._watchMap[e];n&&c(n,function(e){e(t)});var i=this._userWatchMap[e];i&&c(i,function(e){e()})}},ke.prototype._compileDOM=function(){J(this,this.el)},ke.prototype.unlink=function(){var e=this;if(this._behaviors=null,this._watchMap=null,this._routeEl=null,this._comCollection.length=0,this._routeTplStore=null,this._comTplStore=null,this._watchSetterCache=null,c(this._eventStore,function(e){f(e.el,e.event,e.handler)}),this._eventStore.length=0,this._children&&(c(this._children,function(e){e._unlinked||e.unlink()}),this._children.length=0),this._context){for(var t=this._context.linker._children,n=t.length,i=-1;++i<n;)if(t[i]===e){t.splice(i,1);break}this._context=null,this.el.parentNode.removeChild(this.el),this.el=null}this.model=null,this._unlinked=!0},Q.helper={addClass:o,removeClass:l,formatString:s,trim:a,each:c,hash:_},Q.filter=function(e,n){!fe[e]&&t(n)&&(fe[e]=n)},Q.com=A;var we=document.createElement("style");return we.type="text/css",we.textContent=".x-hide{display:none !important;}",document.head.insertAdjacentElement("afterBegin",we),Q});