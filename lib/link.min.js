!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.link=t()}(this,function(){"use strict";function e(e){return!!e&&"object"==typeof e}function t(e){return"function"==typeof e}function n(e){return"string"==typeof e}function i(e){return"boolean"==typeof e}function r(e){return n(e)&&"{"===e[0]&&"}"===e[e.length-1]}function o(e,t){e.className.indexOf(t)===-1&&(e.className=u(e.className)+" "+t)}function s(e,t){e.className.indexOf(t)>-1&&(e.className=e.className.replace(new RegExp(t,"g"),""))}function u(e){return"string"==typeof e?e.trim():e}function l(e,t){for(var n=e.length,i=-1;++i<n;)t(e[i],i,e)}function c(e,t,n){return l(Object.keys(t),function(i){e[i]&&n||(e[i]=t[i])}),e}function a(e,t,n){var i=e[t];if(i)n(i);else{var r=new XMLHttpRequest;r.onreadystatechange=function(){r.readyState===XMLHttpRequest.DONE&&200===r.status&&(e[t]=u(r.responseText),n(r.responseText))},r.open("GET",t,!0),r.setRequestHeader("Accept","text/html"),r.send(null)}}function h(e){var t=e.split("."),n=t.length,i=t[n-1];return function(e,r){for(var o=e,s=0;s<n-1;s++)o=o[t[s]];return 1===arguments.length?o[i]:void(o[i]=r)}}function f(e,t){return oe[t]||(oe[t]=d(t))}function d(e){return new Function("t","with(t){ return "+e+";}")}function p(e,t){function n(){e.setPath(e.el.value)}e.linker._eventInfos.unshift({el:e.el,name:t,handler:n})}function m(e){function t(){var t,r=n.value,o=n.checked,s=e.watcher.value;if(i(s))e.setPath(o);else{if(!Array.isArray(s))throw new Error("checkbox should bind with array or boolean value");t=s.indexOf(r),!o&&t>-1?s.splice(t,1):s.push(r)}}var n=e.el;e.linker._eventInfos.unshift({el:n,name:"click",handler:t})}function v(e){var t=e.el,n=t.nodeName,i=t.type;if("INPUT"===n)switch(i){case"text":case"password":p(e,"input");break;case"radio":p(e,"click");break;case"checkbox":m(e);break;default:p(e,"input")}else"SELECT"===n?p(e,"change"):p(e,"input")}function y(e){this.el.textContent=e}function g(e){this.className?e?o(this.el,this.className):s(this.el,this.className):e&&o(this.el,e)}function b(e){e?this.el.setAttribute("disabled","disabled"):this.el.removeAttribute("disabled")}function _(e){var t=this.el;if("radio"===t.type){var n=t.value===e;t.checked!=n&&(t.checked=n)}else if("checkbox"===t.type)if(Array.isArray(e))t.checked=e.indexOf(t.value)>-1;else{if(!i(e))throw Error("checkbox should bind with array or a boolean value");t.checked!==e&&(t.checked=e)}else t.value!=e&&(t.value=e)}function w(e){e?this.el.setAttribute("readonly","readonly"):this.el.removeAttribute("readonly")}function k(e){return ue.indexOf(typeof e)>-1}function x(e,t,n,i,r){var o,s=e.linker.model,u=Object.create(null),l=e.dirs;return l||(e.dirs=l=[],F(e.linker,i,l)),u.$index={value:n,enumerable:!0,configurable:!0,writable:!0},u[e["var"]]={value:t,enumerable:!0,configurable:!0,writable:!0},o=new Ce({el:i,model:Object.create(s,u),dirs:l.slice()}),e.linker._children.push(o),o}function E(e,t,n){function i(){for(var e=d.length;e--;)if(f.indexOf(d[e])===-1)return d[e]}function r(){var e,t,n,r=u.length,s=f.length;if(!r)return void(s&&(l(f,function(e){p.removeChild(e.el),m||e.unlink()}),f.length=0));if(m)if(s>=r){l(u,function(e,t){f[t].model[c]=e});for(var a=r;a<s;a++)p.removeChild(f[a].el);f.length=r}else{t=document.createDocumentFragment(),n=d.length,l(f,function(e,t){e.model[c]=u[t]});var v=s;if(n>s)do e=i(),e.model[c]=u[v++],f.push(e),t.appendChild(e.el);while(n>f.length&&v<r);for(;v<r;)o(u[v],v++,m,t)}else t=document.createDocumentFragment(),l(f,function(e){p.removeChild(e.el),e.unlink()}),f.length=0,l(u,function(e,n){o(e,n,m,t)});t&&p.insertBefore(t,h)}function o(e,t,n,i,r){var o=x(s,e,t,a.cloneNode(!0),n);return r||f.push(o),n&&d.push(o),i&&i.appendChild(o.el),o}if(!n||"mutate"!==n.op){var s=this,u=e,c=this["var"],a=this.el,h=this.comment,f=this.lastLinkers,d=this.allLinkers,p=a.parentNode||h.parentNode,m=this.valIsPrimitive;if("undefined"==typeof m&&u.length&&(m=this.valIsPrimitive=k(u[0])),f||(f=this.lastLinkers=[],d=this.allLinkers=[],h=this.comment=document.createComment(""+c),p.insertBefore(h,a),p.removeChild(a)),n){var v,y,g=n.op,b=n.args,_=t===e;switch(g){case"push":(_||e.length>t.length)&&(v=u.length-1,y=o(u[v],v,m),p.insertBefore(y.el,h));break;case"pop":(_||e.length<t.length)&&(y=f.pop(),p.removeChild(y.el),m||y.unlink());break;case"splice":y=Array.prototype.splice.apply(f,b),l(y,function(e){p.removeChild(e.el),m||e.unlink()}),l(f,function(e,t){e.model.$index=t});break;case"unshift":(_||e.length>t.length)&&(y=o(u[0],0,m,null,!0),p.insertBefore(y.el,f[0].el),f.unshift(y));break;case"shift":(_||e.length<t.length)&&(y=f.shift(),p.removeChild(y.el),m||y.unlink());break;default:r()}}else r()}}function A(e){return function(t){var n=this.el;e&&t||!e&&!t?(s(n,"x-hide"),n.style.display=""):(o(n,"x-hide"),n.style.display="none")}}function C(e){this.el.setAttribute(this.directive,e)}function O(e){e&&"object"==typeof e&&(Array.isArray(e)?e.forEach(function(e){return O(e)}):Object.keys(e).forEach(function(t){return O(e[t])}))}function j(e,t){return e.replace(Z,function(e,n){return T(n,t)})}function N(e,t){return T(e,t)}function T(e,t){var n,i,r=e.split("|");return 1===r.length?f(t,e)(t):(i=r[0].trim(),n=r[1].trim(),re[n](f(t,i)(t)))}function P(e,t){return t?ye.test(e):S(e)}function S(e){if(e.indexOf("|")===-1)return!1;for(var t,n,i=e.length,r=0;r<i;)if(t=e[r],'"'===t||"'"===t){for(n=r+1;n<i&&e[n]!==t;)++r;if(!(r<i))throw new Error("bad text");r+=2}else if("|"===t){if(n=r+1,n<i&&e[n]!==t)return!0;r+=2}else++r;return!1}function L(e,t){return function(n){return t?j(e,n):N(e,n)}}function D(e){var t=ae[e.isAttrDir?ne:e.directive];return function(n,i,r){return t.call(e,n,i,r)}}function I(e){var t=h(e);return function(e){return t(this.linker.model,e)}}function $(e){return we[e]||(we[e]=new Function("m","$event","$el","with(m){"+e+"}"))}function H(e,t,n){var i=$(e);return function(e){i(t,e,n)}}function q(e,t,n,i){return _e.create(t,"x-bind",null,n,e,i)}function B(e,t,n,i,r){var o,s=i.slice(1,-1).split(","),u=[];return l(s,function(i){o=i.split(":");var s=_e.create(t,n,o[1].trim(),null,e,r);s.className=o[0].trim(),u.push(s)}),u}function M(e,t,n,i,o){var s,u=[];return r(i)?(s=B(e,t,n,i,o),u=u.concat(s)):(s=_e.create(t,n,i,null,e,o),u.push(s)),u}function U(e,t){if(t._dirs.length){var n=t._dirs.shift();n&&l(n,function(n){n instanceof _e?n.clone(e,t):t._eventInfos.push({el:e,name:n.name,handler:H(n.expr,t.model,e)})}),1===e.nodeType&&l(e.childNodes,function(e){U(e,t)})}}function F(e,t,n){var i,r,o,s,c,a,h,f,d=t.nodeType,p=[];if(1===d){if(c=t.hasAttributes()){if(t.hasAttribute("x-for")){if(r=u(t.getAttribute("x-for")),o=r.split(ee),f=o.length,3!==f&&6!==f)throw new Error("repeat only support expr like: var in array [track by expr].");return t.removeAttribute("x-for"),s=_e.create(t,"x-for",o[2],null,e,n),s["var"]=o[0],6===f&&(s.trackBy=o[5].slice(o[5].indexOf(".")+1)),void(n&&(p.push(s),n.push(p)))}l(t.attributes,function(i){if(a=i.name,h=i.value.trim(),ae[a]){var r=M(e,t,a,h,n);n&&(p=p.concat(r))}else{var o=a[0];o===te?n?p.push({name:a.slice(1),expr:h}):e._eventInfos.push({el:t,name:a.slice(1),handler:H(h,e.model,t)}):o===ne&&(s=_e.create(t,a.slice(1),h,null,e,n,!0),n&&p.push(s))}})}if(W.registeredTagsCount>0&&(i=t.tagName.toUpperCase(),W.registeredTags[i]))return void e._comCollection.push({el:t,config:W.registeredTags[i]});n&&n.push(p.length?p:null),l(t.childNodes,function(t){F(e,t,n)})}else 3===d?(r=t.textContent.trim(),r.length&&Y.test(r)&&p.push(q(e,t,r,n)),n&&n.push(p.length?p:null)):9===d&&l(t.childNodes,function(t){F(e,t)})}function G(e,t,n){var i=z(n)||new xe;Object.defineProperty(e,t,{get:function(){var e=pe.target;return e&&i.addSub(e),n},set:function(e){if(e!==n){if(e!==e&&n!==n)return;if(n=e,"object"==typeof e&&e){var t=i;i=z(e),t.notify(Array.isArray(e))}else i.notify()}}})}function R(e){l(ie,function(t){e[t]=function(n){var i,r=Ee.call(arguments),o=1===r.length?Array.prototype[t].call(e,n):Array.prototype[t].apply(e,r);switch(t){case"push":i=r;break;case"unshift":i=r;break;case"splice":i=r.slice(2)}return i&&i.forEach(function(e){return z(e)}),e.__dep__.notify({op:t,args:r}),o}})}function z(e){if(e&&"object"==typeof e){if(e.hasOwnProperty("__dep__")&&e.__dep__ instanceof xe)return e.__dep__;var t=new xe;return Object.defineProperty(e,"__dep__",{value:t}),Array.isArray(e)?(R(e),e.forEach(function(e){return z(e)})):Object.keys(e).forEach(function(t){return G(e,t,e[t])}),t}}function V(e){var t=e.tag;if(!t)throw new Error("tag is required for a component!");t=t.toUpperCase(),W.registeredTags[t]||(W.registeredTags[t]=e,++W.registeredTagsCount)}function X(e,t){var n=t.config,i=u(n.template),r=t.el;i?J(e,r,n,i):n.templateUrl&&a(e._comTplStore,n.templateUrl,function(t){J(e,r,n,t)})}function J(e,n,i,r){if(n.innerHTML=r,n.children.length>1)throw new Error("component can only have one root element");var o=c({},i);if(o.model&&"function"!=typeof o.model)throw new Error("component model must be a function to return a model data");var s=o.model=o.model(),u=o.methods||(o.methods={});if(o.el=n.children[0],Array.isArray(o.props)){var l,a;o.props.forEach(function(i){l=n.getAttribute(i).trim(),t(e.model[l])?u[i]=e.model[l]:(a=h(l)(e.model),a!==s[i]&&(s[i]=a),e.watch(l,function(e){s[i]=e}))})}e._children.push(new Ce(o))}function K(t){if(!e(t))throw new Error("config must be an object.");return t.el||(t.el=window.document),new Ce(t)}var Q,W={registeredTagsCount:0,registeredTags:Object.create(null)},Y=/\{\{[^\}]+\}\}/,Z=/\{\{([^\}]+)\}\}/g,ee=/\s+/,te="@",ne=":",ie=["push","pop","unshift","shift","reverse","sort","splice"],re=Object.create(null),oe=Object.create(null);if("undefined"!=typeof Promise&&"function"==typeof Promise.resolve){var se=Promise.resolve();Q=function(e){return se.then(e)["catch"](function(e){throw e})}}else Q=function(e){setTimeout(e,0)};var ue=["string","number","boolean"],le=A(!0),ce=A(!1),ae={"x-show":le,"x-hide":ce,"x-bind":y,"x-disabled":b,"x-for":E,"x-class":g,"x-model":_,"x-readonly":w,":":C},he=/^[\w$]+(\.[\w$]+)*$/,fe=0,de={op:"mutate"},pe=function(e,t,n,i){this.id=++fe,this.getter="function"==typeof e?e:he.test(e)?h(e):f(t.model,e),this.linker=t,this.model=t.model,this.deep=i,this.lazy=!n,this.cb=n};pe.prototype.getDeps=function(){return pe.target=this,this.value=this.getter.call(this.model,this.model),this.deep&&O(this.value),pe.target=null,this},pe.prototype.getValue=function(){this.value=this.getter.call(this.model,this.model)},pe.prototype.update=function(e){if(this.lazy)return void(this.dirty=!0);var t=this.value;this.getDeps(),t!==this.value||e?this.cb.call(this.model,this.value,t,e):Array.isArray(this.value)&&this.cb.call(this.model,this.value,t,de)},pe.prototype.updateAsync=function(){pe.run(this)},pe.get=function(e,t,n,i){return new pe(e,t,n,i)},pe.target=null;var me=[],ve=!1;pe.run=function(e){return K.sync?void e.update():void(e.waiting||(e.waiting=!0,me.push(e),ve||(ve=!0,Q(function(){for(var e,t=0;t<me.length;t++)e=me[t],e.waiting=!1,e.update();me.length=0,ve=!1}))))};var ye=/\{\{[^\}\|]+\|[^\}\|]+\}\}/,ge=/(\{\{)/g,be=/(\}\})/g,_e=function(e,t,n,i){this.el=e,this.directive=t,this.linker=n,this.isAttrDir=i};_e.prototype.clone=function(e,t){var n=new _e(e,this.directive,t);return c(n,this,!0),n.watcher=pe.get(this.watcher.getter,t,D(n)),t._watchers.push(n.watcher),"x-model"===this.directive&&v(n),n},_e.create=function(e,t,n,i,r,o,s){var u="x-model"===t,l=new _e(e,t,r,s);return i?l.watcher=pe.get(P(i,!0)?L(i,!0):('"'+i+'"').replace(ge,'"+(').replace(be,')+"'),r,D(l)):l.watcher=pe.get("x-bind"!==t?n:L(n,!1),r,D(l)),u&&(l.setPath=I(n)),o||(u&&v(l),r._watchers.push(l.watcher)),l};var we=Object.create(null),ke=0,xe=function(){this.id=++ke,this.has=Object.create(null),this.subs=[],this.deadSubs=[]};xe.prototype.addSub=function(e){this.has[e.id]||(this.has[e.id]=!0,this.subs.push(e))},xe.prototype.removeSub=function(e){this.has[e.id]&&delete this.has[e.id];var t=this.subs.indexOf(e);t>-1&&this.subs.splice(t,1)},xe.prototype.notify=function(e){var t=this;this.subs.forEach(function(n){n.dead?t.deadSubs.push(n):e?n.update(e):n.updateAsync()}),this.deadSubs.length&&(this.deadSubs.forEach(function(e){return t.removeSub(e)}),this.deadSubs.length=0)};var Ee=Array.prototype.slice,Ae=["created"],Ce=function(e){this.el=n(e.el)?document.querySelector(e.el):e.el,this.model=e.model||{},this._methods=e.methods,this._routes=e.routes,this._dirs=e.dirs,this._computed=e.computed,this._eventInfos=[],this._watchers=[],this._children=[],this._routeEl=null,this._comCollection=[],this._unlinked=!1,this._initLifeCycleHooks(e),this._bootstrap(),W.registeredTagsCount>0&&this._comCollection.length>0&&(this._comTplStore=Object.create(null),this._renderComponent()),"function"==typeof this.created&&this.created(),this._bindEvents()};return Ce.prototype._initLifeCycleHooks=function(e){var t,n=this;Object.keys(e).forEach(function(i){Ae.indexOf(i)>-1&&(t=e[i],"function"==typeof t&&(n[i]=t))})},Ce.prototype._bindEvents=function(){this._eventInfos.forEach(function(e){return e.el.addEventListener(e.name,e.handler,!1)})},Ce.prototype._unbindEvents=function(){this._eventInfos.forEach(function(e){return e.el.removeEventListener(e.name,e.handler,!1)}),this._eventInfos.length=0},Ce.prototype._bootstrap=function(){z(this.model),this._addComputed(),this._compileDOM(),this._watchers.forEach(function(e){return e.update()}),this._methods&&c(this.model,this._methods,!0)},Ce.prototype._addComputed=function(){var e,t=this;for(var n in this._computed)if(e=t._computed[n],"function"==typeof e)Object.defineProperty(t.model,n,{enumerable:!0,get:t._makeComputedGetter(e)});else{var i={enumerable:!0};"function"==typeof e.get&&(i.get=t._makeComputedGetter(e.get)),"function"==typeof e.set&&(i.set=e.set),Object.defineProperty(t.model,n,i)}},Ce.prototype._makeComputedGetter=function(e){var t=pe.get(e,this,null).getDeps();return function(){return(t.dirty||pe.target)&&(t.getValue(),t.dirty=!1),t.value}},Ce.prototype._renderComponent=function(){var e=this;l(this._comCollection,function(t){X(e,t)})},Ce.prototype.watch=function Oe(Oe,e,t){pe.get(Oe,this,e,t).getDeps()},Ce.prototype._compileDOM=function(){this._dirs?U(this.el,this):F(this,this.el)},Ce.prototype.unlink=function(){this._unlinked||(this._unlinked=!0,this._comCollection.length=0,this._children.forEach(function(e){return e.unlink()}),this._watchers.forEach(function(e){return e.dead=!0}),this._unbindEvents(),this.model=null)},K.filter=function(e,t){re[e]||"function"!=typeof t||(re[e]=t)},K.com=V,K});